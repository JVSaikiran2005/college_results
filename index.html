<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Results Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-4xl font-bold text-center mb-6">College Results Portal</h1>

  <!-- Student Section -->
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
    <h2 class="text-2xl font-semibold mb-4">Student Result View 🎓</h2>
    <div class="flex gap-2 mb-4">
      <input id="studentIdInput" type="text" placeholder="Enter Student ID (e.g., S101)" class="flex-1 p-2 border rounded">
      <button id="viewResultsButton" class="px-4 py-2 bg-indigo-600 text-white rounded">View Results</button>
    </div>
    <p id="studentResultsError" class="text-red-600 hidden"></p>

    <div id="studentResultDisplay" class="hidden">
      <h3 class="text-xl font-bold mb-2">Results for <span id="resultStudentName"></span> (<span id="resultStudentId"></span>)</h3>
      <p class="mb-4"><strong>Academic Year:</strong> <span id="resultAcademicYear"></span></p>

      <!-- Regular Results -->
      <div id="regularResults" class="mb-6 hidden">
        <h4 class="text-lg font-semibold text-blue-700 mb-2">📘 Regular Results</h4>
        <ul id="regularSubjects" class="list-disc ml-5"></ul>
        <p><strong>SGPA:</strong> <span id="regularSgpa"></span></p>
        <p><strong>CGPA:</strong> <span id="regularCgpa"></span></p>
      </div>

      <!-- Supply Results -->
      <div id="supplyResults" class="hidden">
        <h4 class="text-lg font-semibold text-red-700 mb-2">📕 Supply Results</h4>
        <ul id="supplySubjects" class="list-disc ml-5"></ul>
        <p><strong>SGPA:</strong> <span id="supplySgpa"></span></p>
        <p><strong>CGPA:</strong> <span id="supplyCgpa"></span></p>
      </div>
    </div>
  </div>

  <!-- Admin Section -->
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-4">Admin Portal 🔑</h2>

    <div id="adminLoginSection">
      <input id="adminLoginEmail" type="email" placeholder="Admin Email" class="w-full p-2 border rounded mb-2">
      <input id="adminLoginPassword" type="password" placeholder="Admin Password" class="w-full p-2 border rounded mb-2">
      <button id="adminLoginButton" class="w-full px-4 py-2 bg-purple-600 text-white rounded">Login</button>
      <p id="adminLoginError" class="text-red-600 hidden mt-2"></p>
    </div>

    <div id="adminPanelSection" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <p class="text-green-600">Logged in as Admin</p>
        <button id="adminLogoutButton" class="px-3 py-1 bg-red-500 text-white rounded">Logout</button>
      </div>
      <input id="resultsFile" type="file" multiple accept=".csv,.xlsx" class="w-full p-2 border rounded mb-2">
      <button id="uploadResultsButton" class="w-full px-4 py-2 bg-purple-600 text-white rounded">Upload Results</button>
      <button id="clearResultsButton" class="w-full px-4 py-2 bg-red-600 text-white rounded mt-2">
  Delete All Results
</button>

      <pre id="adminUploadStatus" class="hidden mt-4 whitespace-pre-wrap"></pre>
    </div>
  </div>

  <script>
    const BACKEND_URL = "http://localhost:5000";
    let isAdminLoggedIn = false;

    function updateAdminUI(loggedIn) {
      document.getElementById("adminLoginSection").classList.toggle("hidden", loggedIn);
      document.getElementById("adminPanelSection").classList.toggle("hidden", !loggedIn);
    }

    // Student Results
    document.getElementById("viewResultsButton").addEventListener("click", async () => {
      const studentId = document.getElementById("studentIdInput").value.trim();
      const errorBox = document.getElementById("studentResultsError");
      const resultBox = document.getElementById("studentResultDisplay");

      errorBox.classList.add("hidden");
      resultBox.classList.add("hidden");

      if (!studentId) {
        errorBox.textContent = "Please enter a Student ID.";
        errorBox.classList.remove("hidden");
        return;
      }

      try {
        const response = await fetch(`${BACKEND_URL}/student/results/${studentId.toUpperCase()}`);
        const data = await response.json();

        if (response.ok) {
          document.getElementById("resultStudentName").textContent = data.name || "N/A";
          document.getElementById("resultStudentId").textContent = data.studentId || "N/A";
          document.getElementById("resultAcademicYear").textContent = data.academicYear || "N/A";

          // Regular
          if (data.regular) {
            document.getElementById("regularResults").classList.remove("hidden");
            document.getElementById("regularSgpa").textContent = data.regular.sgpa || "N/A";
            document.getElementById("regularCgpa").textContent = data.regular.cgpa || "N/A";
            const ul = document.getElementById("regularSubjects");
            ul.innerHTML = "";
            (data.regular.subjects || []).forEach(s => {
              const li = document.createElement("li");
              li.textContent = `${s.name}: ${s.marks}`;
              ul.appendChild(li);
            });
          } else {
            document.getElementById("regularResults").classList.add("hidden");
          }

          // Supply
          if (data.supply) {
            document.getElementById("supplyResults").classList.remove("hidden");
            document.getElementById("supplySgpa").textContent = data.supply.sgpa || "N/A";
            document.getElementById("supplyCgpa").textContent = data.supply.cgpa || "N/A";
            const ul = document.getElementById("supplySubjects");
            ul.innerHTML = "";
            (data.supply.subjects || []).forEach(s => {
              const li = document.createElement("li");
              li.textContent = `${s.name}: ${s.marks}`;
              ul.appendChild(li);
            });
          } else {
            document.getElementById("supplyResults").classList.add("hidden");
          }

          resultBox.classList.remove("hidden");
        } else {
          errorBox.textContent = data.error || "Failed to fetch results.";
          errorBox.classList.remove("hidden");
        }
      } catch {
        errorBox.textContent = "Error fetching results.";
        errorBox.classList.remove("hidden");
      }
    });

    // Admin Login
    document.getElementById("adminLoginButton").addEventListener("click", async () => {
      const email = document.getElementById("adminLoginEmail").value;
      const password = document.getElementById("adminLoginPassword").value;
      const errorBox = document.getElementById("adminLoginError");

      try {
        const response = await fetch(`${BACKEND_URL}/admin/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();

        if (response.ok) {
          isAdminLoggedIn = true;
          updateAdminUI(true);
        } else {
          errorBox.textContent = data.error || "Login failed.";
          errorBox.classList.remove("hidden");
        }
      } catch {
        errorBox.textContent = "Error logging in.";
        errorBox.classList.remove("hidden");
      }
    });

    document.getElementById("adminLogoutButton").addEventListener("click", () => {
      isAdminLoggedIn = false;
      updateAdminUI(false);
    });

    // Admin Upload
    document.getElementById("uploadResultsButton").addEventListener("click", async () => {
      const files = document.getElementById("resultsFile").files;
      const statusBox = document.getElementById("adminUploadStatus");
      statusBox.classList.add("hidden");

      if (!isAdminLoggedIn) {
        statusBox.textContent = "You must be logged in as admin.";
        statusBox.classList.remove("hidden");
        return;
      }
      if (!files.length) {
        statusBox.textContent = "Please select files.";
        statusBox.classList.remove("hidden");
        return;
      }

      const formData = new FormData();
      for (let f of files) formData.append("files", f);

      try {
        const response = await fetch(`${BACKEND_URL}/admin/upload_results`, { method: "POST", body: formData });
        const data = await response.json();
        if (response.ok) {
          let message = data.message;
          if (data.details) {
            message += "\n\nDetails:\n" + data.details.join("\n");
          }
          statusBox.textContent = message;
          statusBox.classList.remove("hidden");
        } else {
          statusBox.textContent = data.error || "Upload failed.";
          statusBox.classList.remove("hidden");
        }
      } catch {
        statusBox.textContent = "Error uploading results.";
        statusBox.classList.remove("hidden");
      }
    });
    document.getElementById("clearResultsButton").addEventListener("click", async () => {
  if (!isAdminLoggedIn) {
    alert("You must be logged in as admin to clear results.");
    return;
  }

  if (!confirm("⚠️ Are you sure you want to delete all student results? This cannot be undone.")) {
    return;
  }

  try {
    const response = await fetch(`${BACKEND_URL}/admin/clear_results`, { method: "POST" });
    const data = await response.json();
    if (response.ok) {
      alert(data.message);
      document.getElementById("adminUploadStatus").textContent = data.message;
      document.getElementById("adminUploadStatus").classList.remove("hidden");
    } else {
      alert(data.error || "Failed to clear results.");
    }
  } catch {
    alert("Error clearing results.");
  }
});

    updateAdminUI(isAdminLoggedIn);
  </script>
</body>
</html>

